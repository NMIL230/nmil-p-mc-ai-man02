# Active Machine Learning for Evaluating Cognition (AMLEC)

This repository accompanies the AMLEC manuscript and provides the full analysis
pipeline used to generate the figures, statistics, and survey summaries reported
in the paper. The code loads the released AMLEC gameplay dataset and survey
responses, fits psychometric functions for Classic and Adaptive game modes,
produces publication-ready figures, and exports consolidated analysis logs.

## Repository Layout

- `data/` – binary exports of the AMLEC gameplay dataset and survey subset
  (`*.pkl`). The default scripts read these files in place.
- `src/figures/` – one script per manuscript figure (Figs. 2–7 and supplement),
  each with a CLI interface for regeneration.
- `src/analysis/` – standalone analyses used in the manuscript narrative (survey
  correlations, adaptive probability surface, trial statistics, etc.).
- `src/utils/` – shared helpers for loading data, fitting models, statistical
  tests, plotting styles, and report formatting.
- `scripts/run_full_analysis.py` – orchestration script that reproduces every
  figure and analysis and writes Markdown reports for the supplementary
  materials.
- `manuscript_figures/` – default export location for figure panels and overlay
  assets. Populated when the figure scripts are executed.
- `manuscript_analysis/` – Markdown reports generated by the orchestration
  script (e.g., `full_analysis_report.md`, `full_stats_report.md`, survey output).

## Environment Setup

1. Create the Conda environment defined for the project:
   ```bash
   conda env create -f environment.yml
   conda activate amlec
   ```
2. (Optional, for Bayes factor calculations) Install R ≥ 4.2 and the
   `BayesFactor` package. From an R session:
   ```r
   install.packages("BayesFactor")
   ```
   Ensure `R` is on your `PATH`, or export `R_HOME` so `rpy2` can locate it. On
   macOS you may also need to expose the R shared libraries, e.g.:
   ```bash
   export DYLD_LIBRARY_PATH="$(R RHOME)/lib:${DYLD_LIBRARY_PATH:-}"
   ```
3. (Optional) Point the analysis scripts to a specific Python by setting
   `ANALYSIS_PYTHON=/path/to/python` before running `scripts/run_full_analysis.py`.

The code uses only standard ASCII characters; UTF-8 locales are recommended when
rendering figures or reports.

## Required Data Assets

The repository expects the following files in `data/`:

- `AMLEC_dataset.pkl` – gameplay session export with Classic and Adaptive mode
  trial outcomes. Used by all figure scripts and trial statistics.
- `AMLEC_survey.pkl` – pre-processed survey subset for the survey correlations
  analysis.
- `compare_generator_rmses.pkl` – cached RMSE trajectories for the sampling
  comparison figure.

If you have updated data exports, place the new binaries in `data/` and adjust
paths via the `--pickle` CLI arguments when running individual scripts.

## Reproducing Manuscript Outputs

The fastest way to regenerate every figure and supporting analysis is:
```bash
python scripts/run_full_analysis.py
```
This command sequentially runs each configured task, writes figures under
`manuscript_figures/Figure0X_*`, collects console output in
`manuscript_analysis/full_analysis_report.md`, and extracts key statistics into
`manuscript_analysis/full_stats_report.md`.

Useful CLI switches:
- `--list-tasks` – show the canonical task names and descriptions.
- `--only Fig04 Fig05` – run a subset of tasks (use figure keys or display
  names).
- `--skip SurveyAnalysis` – exclude selected tasks.
- `--include-supplemental` – also build the supplementary figures (`FigS01`,
  `FigS02`).

Global behaviour (outlier handling, validity masks, survey bounds, etc.) is
configured near the top of `scripts/run_full_analysis.py` via `GLOBAL_OPTIONS`
and can be tuned before executing the pipeline.

Each run writes a JSON snapshot underneath `manuscript_analysis/` capturing the
command line, environment, and per-task outputs to aid reproducibility.

## Figure Scripts

Each manuscript figure can be regenerated independently. Example usage:
```bash
python src/figures/MakeFigure04.py --out manuscript_figures/Figure04_Correlation
```
Common options include:
- `--pickle PATH` – load an alternate AMLEC dataset pickle.
- `--no-exclude-outliers` / `--exclude-outliers` plus `--outlier-method` – control
  data filtering.
- `--adjust-session-effect` – remove the global adaptive vs. classic session
  order effect where relevant.
- `--show-labels`, `--fixed-limits`, and `--filename-stem` – tweak rendering of
  publication assets.

Run any script with `--help` to see its full CLI. Outputs are placed in the
figure-specific subdirectory (`manuscript_figures/Figure0X_*` by default).

## Additional Analyses

- `src/analysis/adaptive_probability_surface.py` – plots the adaptive posterior
  surfaces ordered by posterior slope, with options for validity masking and
  outlier exclusion.
- `src/analysis/report_trial_stats.py` – prints trial-count summaries for Classic
  and Adaptive sessions (with optional filtering for repeats and outliers).
- `src/analysis/survey_data_and_performance.py` – pairs survey metrics with
  performance (`ψθ`), provides equivalence tests, and emits a supplemental plot
  under `manuscript_analysis/Survey Data and Performance/`.
- `src/analysis/extract_survey_subset.py` – helper to re-extract the Qualtrics
  data subset used in the manuscript.

These scripts respect the same CLI conventions (e.g., `--pickle`,
`--exclude-outliers`, `--survey-metrics`) and can be combined with the data
utilities in `src/utils/` for bespoke analyses.

## Utility Modules

The `src/utils/` package exposes reusable components used throughout the
pipeline:
- `utils/data/` – PID normalisation, pairing logic, and common input loaders.
- `utils/modeling/` – sigmoid fitting, adaptive posterior assembly, Gaussian
  process helpers.
- `utils/statistics/` – correlation metrics, Bayes factor wrappers, and
  outlier-detection routines.
- `utils/plotting/` – shared Matplotlib styles and figure naming conventions.
- `utils/reporting/` – formatting helpers that keep console logs aligned with the
  manuscript text.

Import these modules directly when extending the analysis suite.

## Troubleshooting

- **Bayes factor unavailable** – ensure R and `BayesFactor` are installed and
  that `rpy2` can locate the R shared libraries. Disable Bayes-factor reporting
  by setting `survey_equivalence_bound` or skipping the survey analysis task if
  R integration is impossible.
- **Missing data files** – the orchestration script prints explicit paths when a
  pickle is absent. Verify the `data/` directory and command-line overrides.
- **Figure label overlap** – several scripts expose `--show-point-labels` or
  `--no-show-sort-metric` toggles to adjust annotations for publication.

For deeper customisation, edit the relevant builder functions or overrides in
`scripts/run_full_analysis.py` and re-run the desired tasks.

